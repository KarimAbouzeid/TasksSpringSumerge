<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>To Do List</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div class="container">
      <h1>To Do List</h1>

      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <input
              type="search"
              id="searchBar"
              class="form-control rounded"
              oninput="handleSearch(this.value)"
              placeholder="Search..."
            />
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div id="myListToDo"></div>
          </div>
        </div>
        <div id="myListDone"></div>
        <div class="form-group">
          <input type="text" id="inputField" placeholder="Add Task" />
        </div>
        <button
          id="buttonAddToList"
          class="btn btn-primary"
          onclick="addToList()"
        >
          Add to List
        </button>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
      import {
        getFirestore,
        addDoc,
        collection,
        getDocs,
        updateDoc,
        doc,
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

      // import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDdiGIBOxqgcpuAslX_Vst9tse89vKDAv8",
        authDomain: "sumergetask.firebaseapp.com",
        projectId: "sumergetask",
        storageBucket: "sumergetask.appspot.com",
        messagingSenderId: "612619750026",
        appId: "1:612619750026:web:784ef2e9a8bfd42fa2fb73",
        measurementId: "G-FE00X17VCK",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);

      // Initialize Cloud Firestore and get a reference to the service
      const db = getFirestore(app);

      let id = 0;
      let searchKey = "";
      const arr = [];

      // On Page Load call the database to get the data
      window.onload = async () => {
        const querySnapshot = await getDocs(collection(db, "posts"));
        querySnapshot.forEach((doc) => {
          arr.push(doc.data());
        });
        arrDisplay(arr);
      };

      const arrDisplay = (arrDisplayed) => {
        let listToDo = document.getElementById("myListToDo");
        let listDone = document.getElementById("myListDone");
        listToDo.innerHTML = "";
        listDone.innerHTML = "";

        arrDisplayed
          .filter((elem) => elem.status == "todo")
          .map((elem, index) => {
            let div = document.createElement("div");
            div.innerHTML = `<div class="row">
                              <div class="col-md-6 col-sm-12 d-flex justify-content-center align-items-left">
                                <p>${elem.name}</p>
                              </div>
                              <div class="col-md-6 col-sm-12 d-flex justify-content-center align-items-left">
                                <button class="btn btn-success" onclick="completeTask('${elem.id}')"> Complete </button>
                              </div>
                            </div>`;
            div.classList.add("mb-3");
            listToDo.appendChild(div);
          });

        arrDisplayed
          .filter((elem) => elem.status == "done")
          .map((elem) => {
            let div = document.createElement("div");
            let p = document.createElement("p");
            div.innerHTML = `<p class="done">${elem.name}</p>`;
            listDone.appendChild(div);
          });
      };

      const deleteSearch = () => {
        searchKey = "";
        let searchBar = document.getElementById("searchBar");
        searchBar.value = "";
      };

      const handleSearch = (inputKey) => {
        searchKey = inputKey;
        const arrSearched = arr.filter((elem) => elem.name.includes(searchKey));
        arrDisplay(arrSearched);
      };

      const addToList = async () => {
        const input = document.getElementById("inputField").value;
        const object = { name: input, status: "todo" };

        try {
          const docRef = await addDoc(collection(db, "posts"), object);

          await updateDoc(docRef, { id: docRef.id });
          arr.push({ id: docRef.id, ...object });
          deleteSearch();
          arrDisplay(arr);
          document.getElementById("inputField").value = "";

          console.log("Document written with ID: ", docRef.id);
        } catch (e) {
          console.error("Error adding document: ", e);
        }
      };

      const completeTask = (id) => {
        arr.forEach(async (elem) => {
          if (elem.id == id) {
            try {
              const updatedDocRef = doc(db, "posts", id);
              await updateDoc(updatedDocRef, {
                status: "done",
              });
              elem.status = "done";
              handleSearch(searchKey);
            } catch (e) {
              console.error("Error updating document: ", e);
            }
          }
        });
      };

      window.addToList = addToList;
      window.handleSearch = handleSearch;
      window.completeTask = completeTask;
    </script>
  </body>
</html>
